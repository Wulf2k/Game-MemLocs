import System;
import System.IO;
import System.Text;
import System.Windows.Forms;
import Fiddler;
import System.Diagnostics;


class Handlers
{    
    static var logtofile = true;
    static var logBloodwebTofile = true;
    static var logCurrencyTofile = true;
    static var logDCPenaltyTofile = true;
    static var folder = "C:/DBD-DumpData";
    public static var sb = new StringBuilder();
	
    static var postgameKillerCsvPath = Path.Combine(folder, "PostGame-Killer.csv");
    static var gameplayKillerCsvPath = Path.Combine(folder, "Gameplay-Killer.csv");
    static var matchInfoCsvPath = Path.Combine(folder, "MatchInfo.csv");
    static var survivorPostgameCsvPath = Path.Combine(folder, "PostGame-Survivor.csv");
    static var gameplaySurvivorCsvPath = Path.Combine(folder, "Gameplay-Survivor.csv");
	
    static var postgameKillerCsvHeaders = ["Timestamp", "Match ID", "Character Name", "Game Mode", "Match End Reason", "Used Surrender Option", "Game Duration", "Escapees Count", "Sacrificed Count", "Killed Count", "Disconnect Count", "Bot Count", "Bloodweb Points", "Brutality", "Deviousness", "Hunter", "Sacrifice", "Brutality Bonus", "Deviousness Bonus", "Hunter Bonus", "Sacrifice Bonus", "Time Open Gate", "Survivor Spawning Position", "Generators Done", "Generator Repair Timestamp1", "Generator Repair Timestamp2", "Generator Repair Timestamp3", "Generator Repair Timestamp4", "Generator Repair Timestamp5", "Generators Max Regression Count", "Generator Kicks Count", "EGS Starter", "EGS Time", "EGS Duration", "EGS Sacrifice", "EGS Reach End", "Used Controller", "Used Keyboard", "Used Haptics Vibration", "Bonus Event", "Special Event Points", "Special Event Points Bonus", "Misc Points", "Match Incentive", "GO Next System Bonus", "GO Next System Multiplier", "Anti-Tunneling Bonus", "LTE Incentive", "Matchmaking Incentive Percentage", "Base Incentive Percentage", "Hidden Base Incentive Percentage", "Matchmaking Incentive Ratio", "Is ABot", "Rank", "Pips Gained or Lost", "Is Tutorial Bot Match", "Onboarding Enabled", "Onboarding ABTesting Enabled", "Onboarding Number Active Modes", "Onboarding New Assigned Mode", "Exact Ping", "Server Region", "Is PWYW", "Is Priority Matchmaking Match"
        ];
	
    static var gameplayKillerHeaders = ["Timestamp", "Character", "Match ID", "Game Mode", "Hook Count", "Murder Count", "Escapees Hatch Count", "Speed", "Bloodlust Tier1 Count", "Bloodlust Tier2 Count", "Bloodlust Tier3 Count", "Bloodlust Tier1 Duration", "Bloodlust Tier2 Duration", "Bloodlust Tier3 Duration", "Bloodlust Speed", "Chase Count", "Chase Count Fail", "Chase Count Success", "Chase Count Tier1 Fail", "Chase Count Tier1 Success", "Chase Count Tier2 Fail", "Chase Count Tier2 Success", "Chase Count Tier3 Fail", "Chase Count Tier3 Success", "Pallet Spawned", "Pallet Procedural", "Pallet Procedural Set Count", "Pallet Generic", "Pallet Destroyed", "Breakable Wall Spawned", "Breakable Wall Destroyed", "Drop Count", "Hit Close Count", "Hit Close Count Success", "Hit Far Count", "Hit Far Count Success", "Hit Special Count", "Hit Special Count Success", "Closet Open", "Closet Open Success", "Seconds At Least One Survivor Hooked", "Amount Tiles Visited", "Start X", "Start Y", "Start Z"
        ];

    static var matchInfoHeaders = ["Timestamp", "Match ID", "Game Mode", "Character", "Map", "Loadout Item", "Loadout Item Addon 1", "Loadout Item Addon 2", "Loadout Offering", "Loadout Perk 1", "Loadout Perk 2", "Loadout Perk 3", "Loadout Perk 4", "Role", "Is ABot", "Bot Difficulty Level", "Party Size", "Character Ownership", "Rank", "Level", "Prestige", "Pips", "Pips Total", "Selected Country", "First Time Playing", "Cumulative Matches", "Cumulative Matches As Survivor", "Cumulative Matches As Killer", "Exact Ping", "Has An Active Archive Quest", "Is Using Keyboard", "Controller Type", "Invert Y", "Colorblind Mode", "Colorblind Intensity", "Terror Radius Visual Support", "Is Tutorial Bot Match", "Onboarding Mode ID", "Onboarding Enabled", "Onboarding", "ABTesting Enabled", "Onboarding Number Active Modes", "Onboarding New Assigned Mode", "Is PWYW", "Is Priority Matchmaking Match"];
	
    static var survivorPostgameHeaders = ["Timestamp","Match ID","Game Mode","Character","Outcome","Match End Reason","Damage State","Game Duration","Hooked Count","Used Surrender Option","Bloodpoints Earned","Objectives Points","Survival Points","Altruism Points","Boldness Points","Objectives Bonus","Survival Bonus","Altruism Bonus","Boldness Bonus","Repair Cancelled Before Regression Stopped Count","Used Controller","Used Keyboard","Used Haptics Vibration","Bonus Event","Special Event Points","Special Event Points Bonus","Misc Points","Match Incentive","Go Next System Bonus","Go Next System Multiplier","Anti Tunneling Bonus","LTE Incentive","Matchmaking Incentive Percentage","Base Incentive Percentage","Hidden Base Incentive Percentage","Matchmaking Incentive Ratio","Is ABot","Rank","Pips Gained Or Lost","Is Tutorial Bot Match","Server Region","Exact Ping"];
	
    static var gameplaySurvivorHeaders = ["Timestamp","Match ID","Game Mode","Character","Hatch","Speed","Injured Speed","Injured Duration","Healthy Duration","KO Duration","Pallet Spawned","Pallet Procedural","Pallet Procedural Set Count","Pallet Generic","Pallet Drop","Pallet Stun","Unhook Count","Heal Count","Heal Count Success","Closet Enter","Skill Check Count","Good Skill Checks","Great Skill Checks","Chase Duration","Number of Chases","Hit By Slasher Count","Unhook Deep Wound Count","KO With Deep Wound Count","All Deep Wound Count","Killer Inflict Deep Wound With Power Count","Tiles Visited","Start X","Start Y","Start Z","Emote Point","Emote Come","Crouching Duration","Crouching Count","Crawling Duration"];
	
            
    public static RulesOption("Hide 304s")
    BindPref("fiddlerscript.rules.Hide304s")
    var m_Hide304s: boolean = false;

    // Cause Fiddler Classic to override the Accept-Language header with one of the defined values
    public static RulesOption("Request &Japanese Content")
    var m_Japanese: boolean = false;

    // Automatic Authentication
    public static RulesOption("&Automatically Authenticate")
    BindPref("fiddlerscript.rules.AutoAuth")
    var m_AutoAuth: boolean = false;

    // Cause Fiddler Classic to override the User-Agent header with one of the defined values
    // The page http://browserscope2.org/browse?category=selectors&ua=Mobile%20Safari is a good place to find updated versions of these
    RulesString("&User-Agents", true) 
    BindPref("fiddlerscript.ephemeral.UserAgentString")
    RulesStringValue(0,"Netscape &3", "Mozilla/3.0 (Win95; I)")
    RulesStringValue(1,"WinPhone8.1", "Mozilla/5.0 (Mobile; Windows Phone 8.1; Android 4.0; ARM; Trident/7.0; Touch; rv:11.0; IEMobile/11.0; NOKIA; Lumia 520) like iPhone OS 7_0_3 Mac OS X AppleWebKit/537 (KHTML, like Gecko) Mobile Safari/537")
    RulesStringValue(2,"&Safari5 (Win7)", "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/533.21.1 (KHTML, like Gecko) Version/5.0.5 Safari/533.21.1")
    RulesStringValue(3,"Safari9 (Mac)", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11) AppleWebKit/601.1.56 (KHTML, like Gecko) Version/9.0 Safari/601.1.56")
    RulesStringValue(4,"iPad", "Mozilla/5.0 (iPad; CPU OS 8_3 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12F5027d Safari/600.1.4")
    RulesStringValue(5,"iPhone6", "Mozilla/5.0 (iPhone; CPU iPhone OS 8_3 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12F70 Safari/600.1.4")
    RulesStringValue(6,"IE &6 (XPSP2)", "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)")
    RulesStringValue(7,"IE &7 (Vista)", "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; SLCC1)")
    RulesStringValue(8,"IE 8 (Win2k3 x64)", "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.2; WOW64; Trident/4.0)")
    RulesStringValue(9,"IE &8 (Win7)", "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)")
    RulesStringValue(10,"IE 9 (Win7)", "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)")
    RulesStringValue(11,"IE 10 (Win8)", "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)")
    RulesStringValue(12,"IE 11 (Surface2)", "Mozilla/5.0 (Windows NT 6.3; ARM; Trident/7.0; Touch; rv:11.0) like Gecko")
    RulesStringValue(13,"IE 11 (Win8.1)", "Mozilla/5.0 (Windows NT 6.3; WOW64; Trident/7.0; rv:11.0) like Gecko")
    RulesStringValue(14,"Edge (Win10)", "Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.11082")
    RulesStringValue(15,"&Opera", "Opera/9.80 (Windows NT 6.2; WOW64) Presto/2.12.388 Version/12.17")
    RulesStringValue(16,"&Firefox 3.6", "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2.7) Gecko/20100625 Firefox/3.6.7")
    RulesStringValue(17,"&Firefox 43", "Mozilla/5.0 (Windows NT 6.3; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0")
    RulesStringValue(18,"&Firefox Phone", "Mozilla/5.0 (Mobile; rv:18.0) Gecko/18.0 Firefox/18.0")
    RulesStringValue(19,"&Firefox (Mac)", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:24.0) Gecko/20100101 Firefox/24.0")
    RulesStringValue(20,"Chrome (Win)", "Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.48 Safari/537.36")
    RulesStringValue(21,"Chrome (Android)", "Mozilla/5.0 (Linux; Android 5.1.1; Nexus 5 Build/LMY48B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/43.0.2357.78 Mobile Safari/537.36")
    RulesStringValue(22,"ChromeBook", "Mozilla/5.0 (X11; CrOS x86_64 6680.52.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.74 Safari/537.36")
    RulesStringValue(23,"GoogleBot Crawler", "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)")
    RulesStringValue(24,"Kindle Fire (Silk)", "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_3; en-us; Silk/1.0.22.79_10013310) AppleWebKit/533.16 (KHTML, like Gecko) Version/5.0 Safari/533.16 Silk-Accelerated=true")
    RulesStringValue(25,"&Custom...", "%CUSTOM%")
    public static var sUA: String = null;

    // Cause Fiddler Classic to delay HTTP traffic to simulate typical 56k modem conditions
    public static RulesOption("Simulate &Modem Speeds", "Per&formance")
    var m_SimulateModem: boolean = false;

    // Removes HTTP-caching related headers and specifies "no-cache" on requests and responses
    public static RulesOption("&Disable Caching", "Per&formance")
    var m_DisableCaching: boolean = false;

    public static RulesOption("Cache Always &Fresh", "Per&formance")
    var m_AlwaysFresh: boolean = false;
        
    // Force a manual reload of the script file.  Resets all
    // RulesOption variables to their defaults.
    public static ToolsAction("Reset Script")
    function DoManualReload() { 
        FiddlerObject.ReloadScript();
    }

    public static ContextAction("Decode Selected Sessions")
    function DoRemoveEncoding(oSessions: Session[]) {
        for (var x:int = 0; x < oSessions.Length; x++){
            oSessions[x].utilDecodeRequest();
            oSessions[x].utilDecodeResponse();
        }
        UI.actUpdateInspector(true,true);
    }

	
	
    static function LogNumericField2(body, displayName, varName) : String {
        var re = new RegExp("\"" + varName + "\"\\s*:\\s*(-?[0-9]+(?:\\.[0-9]+)?)");
        var matchResult = body.match(re);

        if (matchResult && matchResult.length > 1) {
            Debug.WriteLine("  {0}: {1}", displayName, matchResult[1]);
            return matchResult[1];
        }
        return "";
    }

    static function LogStringField2(body, displayName, varName) : String {
        var re = new RegExp("\"" + varName + "\"\\s*:\\s*\"((?:\\\\.|[^\"])*)\"");
        var matchResult = body.match(re);

        if (matchResult && matchResult.length > 1) {
            Debug.WriteLine("  {0}: {1}", displayName, matchResult[1]);
            return matchResult[1];
        }
        return "";
    }
	
    static function LogNumericField(body, displayName, varName) : String { 
        var re = new RegExp("\"" + varName + "\"\\s*:\\s*(-?[0-9]+(?:\\.[0-9]+)?)"); var matchResult = body.match(re); if (matchResult && matchResult.length > 1) { Debug.WriteLine(" {0}: {1}", displayName, matchResult[1]); if (logtofile) { sb.AppendLine(displayName + "," + matchResult[1]); } return matchResult[1]; } return ""; } 
	
    static function LogStringField(body, displayName, varName) : String { var re = new RegExp("\"" + varName + "\"\\s*:\\s*\"((?:\\\\.|[^\"])*)\""); var matchResult = body.match(re); if (matchResult && matchResult.length > 1) { Debug.WriteLine(" {0}: {1}", displayName, matchResult[1]); if (logtofile) { sb.AppendLine(displayName + "," + matchResult[1]); } return matchResult[1]; } return ""; }


    static function OnBeforeRequest(oSession: Session) {

        if ((null != gs_ReplaceToken) && (oSession.url.indexOf(gs_ReplaceToken)>-1)) {   // Case sensitive
            oSession.url = oSession.url.Replace(gs_ReplaceToken, gs_ReplaceTokenWith); 
        }
        if ((null != gs_OverridenHost) && (oSession.host.toLowerCase() == gs_OverridenHost)) {
            oSession["x-overridehost"] = gs_OverrideHostWith; 
        }

        if ((null!=bpRequestURI) && oSession.uriContains(bpRequestURI)) {
            oSession["x-breakrequest"]="uri";
        }

        if ((null!=bpMethod) && (oSession.HTTPMethodIs(bpMethod))) {
            oSession["x-breakrequest"]="method";
        }

        if ((null!=uiBoldURI) && oSession.uriContains(uiBoldURI)) {
            oSession["ui-bold"]="QuickExec";
        }

        if (m_SimulateModem) {
            // Delay sends by 300ms per KB uploaded.
            oSession["request-trickle-delay"] = "300"; 
            // Delay receives by 150ms per KB downloaded.
            oSession["response-trickle-delay"] = "150"; 
        }

        if (m_DisableCaching) {
            oSession.oRequest.headers.Remove("If-None-Match");
            oSession.oRequest.headers.Remove("If-Modified-Since");
            oSession.oRequest["Pragma"] = "no-cache";
        }

        if (null != sUA) {
            oSession.oRequest["User-Agent"] = sUA; 
        }

        if (m_Japanese) {
            oSession.oRequest["Accept-Language"] = "ja";
        }

        if (m_AutoAuth) {
            oSession["X-AutoAuth"] = "(default)";
        }

        if (m_AlwaysFresh && (oSession.oRequest.headers.Exists("If-Modified-Since") || oSession.oRequest.headers.Exists("If-None-Match")))
        {
            oSession.utilCreateResponseAndBypassServer();
            oSession.responseCode = 304;
            oSession["ui-backcolor"] = "Lavender";
        }
        
        
        
        
        
        
        
        
        
        
        
        var body = oSession.GetRequestBodyAsString();
        var matchResult = "";
        
		
        if (!String.IsNullOrEmpty(body)) {
            var cname = "";
            if (logtofile) {
                if (!Directory.Exists(folder)) {
                    Directory.CreateDirectory(folder);
                }
            }
		
            if (oSession.PathAndQuery.Equals("/api/v1/gameDataAnalytics/v2/batch") && body.Contains("postgame_killer"))
            {
                var values = new Array();

                values.push(LogStringField2(body, "Timestamp", "timestamp"));
                values.push(LogStringField2(body, "Match ID", "match_id"));
                values.push(LogStringField2(body, "Character Name", "character_name"));
                values.push(LogStringField2(body, "Game Mode", "game_mode"));
                values.push(LogStringField2(body, "Match End Reason", "match_end_reason"));
                values.push(LogNumericField2(body, "Used Surrender Option", "used_surrender_option"));
                values.push(LogNumericField2(body, "Game Duration", "game_duration"));
                values.push(LogNumericField2(body, "Escapees Count", "escapees_count"));
                values.push(LogNumericField2(body, "Sacrificed Count", "sacrificed_count"));
                values.push(LogNumericField2(body, "Killed Count", "killed_count"));
                values.push(LogNumericField2(body, "Disconnect Count", "disconnect_count"));
                values.push(LogNumericField2(body, "Bot Count", "bot_count"));
                values.push(LogNumericField2(body, "Bloodweb Points", "bloodweb_points"));
                values.push(LogNumericField2(body, "Brutality", "brutality"));
                values.push(LogNumericField2(body, "Deviousness", "deviousness"));
                values.push(LogNumericField2(body, "Hunter", "hunter"));
                values.push(LogNumericField2(body, "Sacrifice", "sacrifice"));
                values.push(LogNumericField2(body, "Brutality Bonus", "brutality_bonus"));
                values.push(LogNumericField2(body, "Deviousness Bonus", "deviousness_bonus"));
                values.push(LogNumericField2(body, "Hunter Bonus", "hunter_bonus"));
                values.push(LogNumericField2(body, "Sacrifice Bonus", "sacrifice_bonus"));
                values.push(LogNumericField2(body, "Time Open Gate", "time_open_gate"));
                values.push(LogStringField2(body, "Survivor Spawning Position", "survivor_spawning_position"));
                values.push(LogNumericField2(body, "Generators Done", "generators_done"));
                values.push(LogNumericField2(body, "Generator Repair Timestamp1", "generator_repair_timestamp1"));
                values.push(LogNumericField2(body, "Generator Repair Timestamp2", "generator_repair_timestamp2"));
                values.push(LogNumericField2(body, "Generator Repair Timestamp3", "generator_repair_timestamp3"));
                values.push(LogNumericField2(body, "Generator Repair Timestamp4", "generator_repair_timestamp4"));
                values.push(LogNumericField2(body, "Generator Repair Timestamp5", "generator_repair_timestamp5"));
                values.push(LogNumericField2(body, "Generators Max Regression Count", "generators_max_regression_count"));
                values.push(LogNumericField2(body, "Generator Kicks Count", "generator_kicks_count"));
                values.push(LogStringField2(body, "EGS Starter", "egs_starter"));
                values.push(LogNumericField2(body, "EGS Time", "egs_time"));
                values.push(LogNumericField2(body, "EGS Duration", "egs_duration"));
                values.push(LogNumericField2(body, "EGS Sacrifice", "egs_sacrifice"));
                values.push(LogNumericField2(body, "EGS Reach End", "egs_reach_end"));
                values.push(LogNumericField2(body, "Used Controller", "used_controller"));
                values.push(LogNumericField2(body, "Used Keyboard", "used_keyboard"));
                values.push(LogNumericField2(body, "Used Haptics Vibration", "used_haptics_vibration"));
                values.push(LogNumericField2(body, "Bonus Event", "bonus_event"));
                values.push(LogNumericField2(body, "Special Event Points", "special_event_points"));
                values.push(LogNumericField2(body, "Special Event Points Bonus", "special_event_points_bonus"));
                values.push(LogNumericField2(body, "Misc Points", "misc_points"));
                values.push(LogNumericField2(body, "Match Incentive", "match_incentive"));
                values.push(LogNumericField2(body, "GO Next System Bonus", "go_next_system_bonus"));
                values.push(LogNumericField2(body, "GO Next System Multiplier", "go_next_system_multiplier"));
                values.push(LogNumericField2(body, "Anti-Tunneling Bonus", "anti_tunneling_bonus"));
                values.push(LogNumericField2(body, "LTE Incentive", "lte_incentive"));
                values.push(LogNumericField2(body, "Matchmaking Incentive Percentage", "matchmaking_incentive_percentage"));
                values.push(LogNumericField2(body, "Base Incentive Percentage", "base_incentive_percentage"));
                values.push(LogNumericField2(body, "Hidden Base Incentive Percentage", "hidden_base_incentive_percentage"));
                values.push(LogNumericField2(body, "Matchmaking Incentive Ratio", "matchmaking_incentive_ratio"));
                values.push(LogNumericField2(body, "Is ABot", "is_abot"));
                values.push(LogNumericField2(body, "Rank", "rank"));
                values.push(LogNumericField2(body, "Pips Gained or Lost", "pips_gained_or_lost"));
                values.push(LogNumericField2(body, "Is Tutorial Bot Match", "is_tutorial_bot_match"));
                values.push(LogNumericField2(body, "Onboarding Enabled", "onboarding_enabled"));
                values.push(LogNumericField2(body, "Onboarding ABTesting Enabled", "onboarding_abtesting_enabled"));
                values.push(LogNumericField2(body, "Onboarding Number Active Modes", "onboarding_number_active_modes"));
                values.push(LogNumericField2(body, "Onboarding New Assigned Mode", "onboarding_new_assigned_mode"));
                values.push(LogNumericField2(body, "Exact Ping", "exact_ping"));
                values.push(LogStringField2(body, "Server Region", "server_region"));
                values.push(LogNumericField2(body, "Is PWYW", "is_pwyw"));
                values.push(LogNumericField2(body, "Is Priority Matchmaking Match", "is_priority_matchmaking_match"));

                if (!File.Exists(postgameKillerCsvPath)) {
                    File.AppendAllText(postgameKillerCsvPath, postgameKillerCsvHeaders.join(",") + "\r\n");
                }

                File.AppendAllText(postgameKillerCsvPath, values.join(",") + "\r\n");
            }

            if (oSession.PathAndQuery.Equals("/api/v1/gameDataAnalytics/v2/batch") && body.Contains("gameplay_killer"))
            {
                Debug.WriteLine("---------------- Analytics - Gameplay Killer ----------------");
                if (logtofile) {

                    var values = new Array();

                    values.push(LogStringField2(body, "Timestamp", "timestamp"));
                    values.push(LogStringField2(body, "Character", "character_name"));
                    values.push(LogStringField2(body, "Match ID", "match_id"));
                    values.push(LogStringField2(body, "Game Mode", "game_mode"));

                    values.push(LogNumericField2(body, "Hook Count", "hook_count"));
                    values.push(LogNumericField2(body, "Murder Count", "murder_count"));
                    values.push(LogNumericField2(body, "Escapees Hatch Count", "escapees_hatch_count"));
                    values.push(LogNumericField2(body, "Speed", "speed"));

                    values.push(LogNumericField2(body, "Bloodlust Tier1 Count", "bloodlust_tier1_count"));
                    values.push(LogNumericField2(body, "Bloodlust Tier2 Count", "bloodlust_tier2_count"));
                    values.push(LogNumericField2(body, "Bloodlust Tier3 Count", "bloodlust_tier3_count"));
                    values.push(LogNumericField2(body, "Bloodlust Tier1 Duration", "bloodlust_tier1_duration"));
                    values.push(LogNumericField2(body, "Bloodlust Tier2 Duration", "bloodlust_tier2_duration"));
                    values.push(LogNumericField2(body, "Bloodlust Tier3 Duration", "bloodlust_tier3_duration"));
                    values.push(LogNumericField2(body, "Bloodlust Speed", "bloodlust_speed"));

                    values.push(LogNumericField2(body, "Chase Count", "chase_count"));
                    values.push(LogNumericField2(body, "Chase Count Fail", "chase_count_fail"));
                    values.push(LogNumericField2(body, "Chase Count Success", "chase_count_success"));
                    values.push(LogNumericField2(body, "Chase Count Tier1 Fail", "chase_count_tier1_fail"));
                    values.push(LogNumericField2(body, "Chase Count Tier1 Success", "chase_count_tier1_success"));
                    values.push(LogNumericField2(body, "Chase Count Tier2 Fail", "chase_count_tier2_fail"));
                    values.push(LogNumericField2(body, "Chase Count Tier2 Success", "chase_count_tier2_success"));
                    values.push(LogNumericField2(body, "Chase Count Tier3 Fail", "chase_count_tier3_fail"));
                    values.push(LogNumericField2(body, "Chase Count Tier3 Success", "chase_count_tier3_success"));

                    values.push(LogNumericField2(body, "Pallet Spawned", "pallet_spawned"));
                    values.push(LogNumericField2(body, "Pallet Procedural", "pallet_procedural"));
                    values.push(LogNumericField2(body, "Pallet Procedural Set Count", "pallet_procedural_set_count"));
                    values.push(LogNumericField2(body, "Pallet Generic", "pallet_generic"));
                    values.push(LogNumericField2(body, "Pallet Destroyed", "pallet_destroyed"));

                    values.push(LogNumericField2(body, "Breakable Wall Spawned", "breakable_wall_spawned"));
                    values.push(LogNumericField2(body, "Breakable Wall Destroyed", "breakable_wall_destroyed"));

                    values.push(LogNumericField2(body, "Drop Count", "drop_count"));
                    values.push(LogNumericField2(body, "Hit Close Count", "hit_close_count"));
                    values.push(LogNumericField2(body, "Hit Close Count Success", "hit_close_count_success"));
                    values.push(LogNumericField2(body, "Hit Far Count", "hit_far_count"));
                    values.push(LogNumericField2(body, "Hit Far Count Success", "hit_far_count_success"));
                    values.push(LogNumericField2(body, "Hit Special Count", "hit_special_count"));
                    values.push(LogNumericField2(body, "Hit Special Count Success", "hit_special_count_success"));

                    values.push(LogNumericField2(body, "Closet Open", "closet_open"));
                    values.push(LogNumericField2(body, "Closet Open Success", "closet_open_success"));
                    values.push(LogNumericField2(body, "Seconds At Least One Survivor Hooked", "secondes_at_least_one_survivor_hooked"));
                    values.push(LogNumericField2(body, "Amount Tiles Visited", "amount_tiles_visited"));

                    values.push(LogNumericField2(body, "Start X", "start_x"));
                    values.push(LogNumericField2(body, "Start Y", "start_y"));
                    values.push(LogNumericField2(body, "Start Z", "start_z"));

                    if (!File.Exists(gameplayKillerCsvPath)) {
                        File.AppendAllText(
                            gameplayKillerCsvPath,
                            gameplayKillerHeaders.join(",") + "\r\n"
                            );
                    }

                    File.AppendAllText(gameplayKillerCsvPath, values.join(",") + "\r\n");
                }

                Debug.WriteLine("---------------- End Analytics - Gameplay Killer ----------------");

            }
			
            if (oSession.PathAndQuery.Equals("/api/v1/gameDataAnalytics/v2/batch") && body.Contains("postgame_survivor"))
            {
                Debug.WriteLine("---------------- GameLog - Survivor Postgame ----------------");
                if (logtofile) {
                    var values = new Array();

                    values.push(LogStringField2(body, "Timestamp", "timestamp"));
                    values.push(LogStringField2(body, "Match ID", "match_id"));
                    values.push(LogStringField2(body, "Game Mode", "game_mode"));
                    values.push(LogStringField2(body, "Character", "character_name"));
                    values.push(LogStringField2(body, "Outcome", "outcome"));
                    values.push(LogStringField2(body, "Match End Reason", "match_end_reason"));
                    values.push(LogStringField2(body, "Damage State", "damage_state"));
                    values.push(LogNumericField2(body, "Game Duration", "game_duration"));
                    values.push(LogNumericField2(body, "Hooked Count", "hooked_count"));
                    values.push(LogNumericField2(body, "Used Surrender Option", "used_surrender_option"));
                    values.push(LogNumericField2(body, "Bloodpoints Earned", "bloodweb_points"));
                    values.push(LogNumericField2(body, "Objectives Points", "objectives"));
                    values.push(LogNumericField2(body, "Survival Points", "survival"));
                    values.push(LogNumericField2(body, "Altruism Points", "altruism"));
                    values.push(LogNumericField2(body, "Boldness Points", "boldness"));
                    values.push(LogNumericField2(body, "Objectives Bonus", "objectives_bonus"));
                    values.push(LogNumericField2(body, "Survival Bonus", "survival_bonus"));
                    values.push(LogNumericField2(body, "Altruism Bonus", "altruism_bonus"));
                    values.push(LogNumericField2(body, "Boldness Bonus", "boldness_bonus"));
                    values.push(LogNumericField2(body,"Repair Cancelled Before Regression Stopped Count","repair_canceled_before_regression_stopped_count"));
                    values.push(LogNumericField2(body, "Used Controller", "used_controller"));
                    values.push(LogNumericField2(body, "Used Keyboard", "used_keyboard"));
                    values.push(LogNumericField2(body, "Used Haptics Vibration", "used_haptics_vibration"));
                    values.push(LogNumericField2(body, "Bonus Event", "bonus_event"));
                    values.push(LogNumericField2(body, "Special Event Points", "special_event_points"));
                    values.push(LogNumericField2(body, "Special Event Points Bonus", "special_event_points_bonus"));
                    values.push(LogNumericField2(body, "Misc Points", "misc_points"));
                    values.push(LogNumericField2(body, "Match Incentive", "match_incentive"));
                    values.push(LogNumericField2(body, "Go Next System Bonus", "go_next_system_bonus"));
                    values.push(LogNumericField2(body, "Go Next System Multiplier", "go_next_system_multiplier"));
                    values.push(LogNumericField2(body, "Anti Tunneling Bonus", "anti_tunneling_bonus"));
                    values.push(LogNumericField2(body, "LTE Incentive", "lte_incentive"));
                    values.push(LogNumericField2(body, "Matchmaking Incentive Percentage", "matchmaking_incentive_percentage"));
                    values.push(LogNumericField2(body, "Base Incentive Percentage", "base_incentive_percentage"));
                    values.push(LogNumericField2(body, "Hidden Base Incentive Percentage", "hidden_base_incentive_percentage"));
                    values.push(LogNumericField2(body, "Matchmaking Incentive Ratio", "matchmaking_incentive_ratio"));
                    values.push(LogNumericField2(body, "Is ABot", "is_abot"));
                    values.push(LogNumericField2(body, "Rank", "rank"));
                    values.push(LogNumericField2(body, "Pips Gained Or Lost", "pips_gained_or_lost"));
                    values.push(LogNumericField2(body, "Is Tutorial Bot Match", "is_tutorial_bot_match"));
                    values.push(LogStringField2(body, "Server Region", "server_region"));
                    values.push(LogNumericField2(body, "Exact Ping", "exact_ping"));

                    if (!File.Exists(survivorPostgameCsvPath)) {
                        File.AppendAllText(
                            survivorPostgameCsvPath,
                            survivorPostgameHeaders.join(",") + "\r\n"
                            );
                    }

                    File.AppendAllText(survivorPostgameCsvPath,values.join(",") + "\r\n");
                }

                Debug.WriteLine("---------------- End GameLog - Survivor Postgame ----------------");
            }
			
			
			
			
			
			
			
			
            //Gameplay - Survivor
            if (oSession.PathAndQuery.Equals("/api/v1/gameDataAnalytics/v2/batch") && body.Contains("gameplay_survivor"))
            {
                Debug.WriteLine("---------------- Analytics - Gameplay Survivor ----------------");
                if (logtofile) {

                    var values = new Array();

                    values.push(LogStringField2(body, "Timestamp", "timestamp"));
                    values.push(LogStringField2(body, "Match ID", "match_id"));
                    values.push(LogStringField2(body, "Game Mode", "game_mode"));
                    values.push(LogStringField2(body, "Character", "character_name"));
                    values.push(LogNumericField2(body, "Hatch", "hatch").ToString());
                    values.push(LogNumericField2(body, "Speed", "speed").ToString());
                    values.push(LogNumericField2(body, "Injured Speed", "injured_speed").ToString());
                    values.push(LogNumericField2(body, "Injured Duration", "injured_duration").ToString());
                    values.push(LogNumericField2(body, "Healthy Duration", "healthy_duration").ToString());
                    values.push(LogNumericField2(body, "KO Duration", "ko_duration").ToString());
                    values.push(LogNumericField2(body, "Pallet Spawned", "pallet_spawned").ToString());
                    values.push(LogNumericField2(body, "Pallet Procedural", "pallet_procedural").ToString());
                    values.push(LogNumericField2(body, "Pallet Procedural Set Count", "pallet_procedural_set_count").ToString());
                    values.push(LogNumericField2(body, "Pallet Generic", "pallet_generic").ToString());
                    values.push(LogNumericField2(body, "Pallet Drop", "pallet_drop").ToString());
                    values.push(LogNumericField2(body, "Pallet Stun", "pallet_stun").ToString());
                    values.push(LogNumericField2(body, "Unhook Count", "unhook_count").ToString());
                    values.push(LogNumericField2(body, "Heal Count", "heal_count").ToString());
                    values.push(LogNumericField2(body, "Heal Count Success", "heal_count_success").ToString());
                    values.push(LogNumericField2(body, "Closet Enter", "closet_enter").ToString());
                    values.push(LogNumericField2(body, "Skill Check Count", "skill_check_count").ToString());
                    values.push(LogNumericField2(body, "Good Skill Checks", "skill_check_count_good").ToString());
                    values.push(LogNumericField2(body, "Great Skill Checks", "skill_check_count_great").ToString());
                    values.push(LogNumericField2(body, "Chase Duration", "chase_duration").ToString());
                    values.push(LogNumericField2(body, "Number of Chases", "num_chases").ToString());
                    values.push(LogNumericField2(body, "Hit By Slasher Count", "hit_by_slasher_count").ToString());
                    values.push(LogNumericField2(body, "Unhook Deep Wound Count", "unhook_deep_wound_count").ToString());
                    values.push(LogNumericField2(body, "KO With Deep Wound Count", "kowith_deep_wound_count").ToString());
                    values.push(LogNumericField2(body, "All Deep Wound Count", "all_deep_wound_count").ToString());
                    values.push(LogNumericField2(body, "Killer Inflict Deep Wound With Power Count", "killer_inflict_deep_wound_with_power_count").ToString());
                    values.push(LogNumericField2(body, "Tiles Visited", "amount_tiles_visited").ToString());
                    values.push(LogNumericField2(body, "Start X", "start_x").ToString());
                    values.push(LogNumericField2(body, "Start Y", "start_y").ToString());
                    values.push(LogNumericField2(body, "Start Z", "start_z").ToString());
                    values.push(LogNumericField2(body, "Emote Point", "emote_point").ToString());
                    values.push(LogNumericField2(body, "Emote Come", "emote_come").ToString());
                    values.push(LogNumericField2(body, "Crouching Duration", "crouching_duration").ToString());
                    values.push(LogNumericField2(body, "Crouching Count", "crouching_count").ToString());
                    values.push(LogNumericField2(body, "Crawling Duration", "crawling_duration").ToString());
                    if (!File.Exists(gameplaySurvivorCsvPath)) {
                        //File.AppendAllText(gameplaySurvivorCsvPath, values.join(",") + "\r\n");
						File.AppendAllText(gameplaySurvivorCsvPath, gameplaySurvivorHeaders.join(",") + "\r\n");
                    }
                    File.AppendAllText(gameplaySurvivorCsvPath, values.join(",") + "\r\n");
                    Debug.WriteLine("---------------- End Analytics - Gameplay Survivor ----------------");
                }
            }
            
			
            //Match Info
            if (oSession.PathAndQuery.Equals("/api/v1/gameDataAnalytics/v2/batch") && body.Contains("matchinfo")) {
                Debug.WriteLine("---------------- Match Info ----------------");

                if (logtofile) {

                    var values = new Array();

                    values.push(LogStringField2(body, "Timestamp", "timestamp"));
                    values.push(LogStringField2(body, "Match ID", "match_id"));
                    values.push(LogStringField2(body, "Game Mode", "game_mode"));
                    values.push(LogStringField2(body, "Character", "character_name"));

                    values.push(LogStringField2(body, "Map", "map_name"));

                    values.push(LogStringField2(body, "Loadout Item", "loadout_item"));
                    values.push(LogStringField2(body, "Loadout Item Addon 1", "loadout_item_add_on1"));
                    values.push(LogStringField2(body, "Loadout Item Addon 2", "loadout_item_add_on2"));
                    values.push(LogStringField2(body, "Loadout Offering", "loadout_offering"));
                    values.push(LogStringField2(body, "Loadout Perk 1", "loadout_perk1"));
                    values.push(LogStringField2(body, "Loadout Perk 2", "loadout_perk2"));
                    values.push(LogStringField2(body, "Loadout Perk 3", "loadout_perk3"));
                    values.push(LogStringField2(body, "Loadout Perk 4", "loadout_perk4"));
                    values.push(LogStringField2(body, "Role", "role"));
                    values.push(LogNumericField2(body, "Is ABot", "is_abot"));
                    values.push(LogStringField2(body, "Bot Difficulty Level", "bot_difficulty_level"));
                    values.push(LogNumericField2(body, "Party Size", "party_size"));
                    values.push(LogStringField2(body, "Character Ownership", "character_ownership"));
                    values.push(LogNumericField2(body, "Rank", "rank"));
                    values.push(LogNumericField2(body, "Level", "level"));
                    values.push(LogNumericField2(body, "Prestige", "prestige"));
                    values.push(LogNumericField2(body, "Pips", "pips"));
                    values.push(LogNumericField2(body, "Pips Total", "pips_total"));

                    values.push(LogStringField2(body, "Selected Country", "selected_country"));
                    values.push(LogNumericField2(body, "First Time Playing", "first_time_playing"));
                    values.push(LogNumericField2(body, "Cumulative Matches", "cumulative_matches"));
                    values.push(LogNumericField2(body, "Cumulative Matches As Survivor", "cumulative_matches_as_survivor"));
                    values.push(LogNumericField2(body, "Cumulative Matches As Killer", "cumulative_matches_as_killer"));
                    values.push(LogNumericField2(body, "Exact Ping", "exact_ping"));
                    values.push(LogNumericField2(body, "Has An Active Archive Quest", "has_an_active_archive_quest"));
                    values.push(LogNumericField2(body, "Is Using Keyboard", "is_using_keyboard"));
                    values.push(LogStringField2(body, "Controller Type", "controller_type"));
                    values.push(LogNumericField2(body, "Invert Y", "invert_y"));
                    values.push(LogStringField2(body, "Colorblind Mode", "colorblind_mode"));
                    values.push(LogNumericField2(body, "Colorblind Intensity", "colorblind_intensity"));
                    values.push(LogNumericField2(body, "Terror Radius Visual Support", "terror_radius_visual_support"));
                    values.push(LogNumericField2(body, "Is Tutorial Bot Match", "is_tutorial_bot_match"));

                    values.push(LogStringField2(body, "Onboarding Mode ID", "onboarding_mode_id"));
                    values.push(LogNumericField2(body, "Onboarding Enabled", "onboarding_enabled"));
                    values.push(LogNumericField2(body, "Onboarding ABTesting Enabled", "onboarding_abtesting_enabled"));
                    values.push(LogNumericField2(body, "Onboarding Number Active Modes", "onboarding_number_active_modes"));
                    values.push(LogNumericField2(body, "Onboarding New Assigned Mode", "onboarding_new_assigned_mode"));

                    values.push(LogNumericField2(body, "Is PWYW", "is_pwyw"));
                    values.push(LogNumericField2(body, "Is Priority Matchmaking Match", "is_priority_matchmaking_match"));

                    if (!File.Exists(matchInfoCsvPath)) {
                        File.AppendAllText(matchInfoCsvPath, matchInfoHeaders.join(",") + "\r\n");
					}
                    File.AppendAllText(
                        matchInfoCsvPath,
                        values.join(",") + "\r\n"
                        );
                    

                }

                Debug.WriteLine("---------------- End Match Info ----------------");
            }            
        }  
    }

    
    /*
    static function OnPeekAtRequestHeaders(oSession: Session) {
    var sProc = ("" + oSession["x-ProcessInfo"]).ToLower();
    if (!sProc.StartsWith("mylowercaseappname")) oSession["ui-hide"] = "NotMyApp";
    }
    */

    
    static function OnPeekAtResponseHeaders(oSession: Session) {
        //Debug.WriteLine("Session {0}: Response header peek shows status is {1}", oSession.id, oSession.responseCode);
        if (m_DisableCaching) {
            oSession.oResponse.headers.Remove("Expires");
            oSession.oResponse["Cache-Control"] = "no-cache";
        }

        if ((bpStatus>0) && (oSession.responseCode == bpStatus)) {
            oSession["x-breakresponse"]="status";
            oSession.bBufferResponse = true;
        }
        
        if ((null!=bpResponseURI) && oSession.uriContains(bpResponseURI)) {
            oSession["x-breakresponse"]="uri";
            oSession.bBufferResponse = true;
        }

    }

    static function OnBeforeResponse(oSession: Session) {
        if (m_Hide304s && oSession.responseCode == 304) {
            oSession["ui-hide"] = "true";
        }

        if (!oSession.oResponse.headers.ExistsAndContains("Content-Type", "application/json"))
            return;

        if (oSession.bHasResponse) {
            oSession.utilDecodeResponse();
            var body = oSession.GetResponseBodyAsString();
            
            
            if (!String.IsNullOrEmpty(body)) {
                if (oSession.PathAndQuery.Equals("/api/v1/queue") && body.Contains("queueSize"))
                {
                    Debug.WriteLine("---------------- Queue request ----------------");
                    LogStringField(body, "Character", "characterName");
                    LogNumericField(body, "Queue Size", "queueSize");
                    LogNumericField(body, "Queue Pos", "position");
                    Debug.WriteLine("---------------- End queue request ----------------");
                }
				

                //DisconnectPenaltyPoints
                if (oSession.PathAndQuery.Equals("/api/v1/players/ban/decayAndGetDisconnectionPenaltyPoints")) {
                    Debug.WriteLine("---------------- Get Disconnection Penalty Points request ----------------");
                    var penalty = LogNumericField(body, "DC Penalty Points", "penaltyPoints");
                    Debug.WriteLine("---------------- End Disconnection Penalty Points request ----------------");
                    
                    if (logDCPenaltyTofile) {
                        var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
                        var path = Path.Combine(folder, "DCPenalty.txt");
                        File.WriteAllText(path, penalty + "-" + timestamp);
                    }
                }
				

                //LocalizedCurrencies
                if (oSession.PathAndQuery.Equals("/api/v1/wallet/currencies") || oSession.PathAndQuery.Equals("/api/v1/extensions/wallet/getLocalizedCurrenciesAfterLogin")) {
                    Debug.WriteLine("---------------- Currencies ----------------");
                    sb = new StringBuilder();
                    var regex = /"currency"\s*:\s*"([^"]+)"\s*,\s*"balance"\s*:\s*([0-9]+(?:\.[0-9]+)?)|"balance"\s*:\s*([0-9]+(?:\.[0-9]+)?)\s*,\s*"currency"\s*:\s*"([^"]+)"/g;
                    var match;
                    while ((match = regex.exec(body)) !== null)
                    {
                        var currency = match[1] || match[4];
                        var balance  = match[2] || match[3];

                        Debug.WriteLine("  {0}: {1}", currency, balance);
                        sb.AppendLine(currency + "," + balance);
                    }
					
					
                    if (logCurrencyTofile) {
                        //var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
                        var path = Path.Combine(folder, "Currencies.txt");
                        File.WriteAllText(path, sb.ToString());
                    }
                    Debug.WriteLine("---------------- End Currencies ----------------");
                }
				
				
                if (oSession.PathAndQuery.Equals("/api/v1/dbd-character-data/bloodweb")) {

                    Debug.WriteLine("---------------- Bloodweb ----------------");
                    var cname = LogStringField(body, "Character", "characterName");
                    var pLevel = LogNumericField(body, "Prestige Level", "prestigeLevel");
                    var bLevel = LogNumericField(body, "Bloodweb Level", "bloodWebLevel");

                    var sb = new StringBuilder();
                    var regex = /"contentId"\s*:\s*"([^"]+)"\s*,\s*"nodeId"\s*:\s*"([^"]+)"|"nodeId"\s*:\s*"([^"]+)"\s*,\s*"contentId"\s*:\s*"([^"]+)"/g;

                    var match;
                    while ((match = regex.exec(body)) !== null) {

                        var contentId = match[1] || match[4];
                        var nodeId    = match[2] || match[3];

                        Debug.WriteLine("  {0} : {1}", contentId, nodeId);
                        sb.AppendLine(contentId + "," + nodeId);
                    }

                    if (logBloodwebTofile) {
                        var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
                        var path = Path.Combine(folder, "Bloodweb");
                        path = Path.Combine(path, cname);
                        if (!Directory.Exists(path)) {
                            Directory.CreateDirectory(path);
                        }

                        var pStr = String.Format("{0:D3}", int(pLevel));
                        var lStr = String.Format("{0:D2}", int(bLevel));

                        path = Path.Combine(
                            path, 					"Bloodweb-" + cname + "-P" + pStr + "-L" + lStr + ".txt"
                            );

                        File.WriteAllText(path, sb.ToString());
                    }

                    Debug.WriteLine("---------------- End Bloodweb ----------------");
                }

            }
        }

    }

/*
    // This function executes just before Fiddler Classic returns an error that it has
    // itself generated (e.g. "DNS Lookup failure") to the client application.
    // These responses will not run through the OnBeforeResponse function above.
    static function OnReturningError(oSession: Session) {
    }
*/
/*
    // This function executes after Fiddler Classic finishes processing a Session, regardless
    // of whether it succeeded or failed. Note that this typically runs AFTER the last
    // update of the Web Sessions UI listitem, so you must manually refresh the Session's
    // UI if you intend to change it.
    static function OnDone(oSession: Session) {
    }
*/

    /*
    static function OnBoot() {
        MessageBox.Show("Fiddler Classic has finished booting");
        System.Diagnostics.Process.Start("iexplore.exe");

        UI.ActivateRequestInspector("HEADERS");
        UI.ActivateResponseInspector("HEADERS");
    }
    */

    /*
    static function OnBeforeShutdown(): Boolean {
        // Return false to cancel shutdown.
        return ((0 == FiddlerApplication.UI.lvSessions.TotalItemCount()) ||
                (DialogResult.Yes == MessageBox.Show("Allow Fiddler Classic to exit?", "Go Bye-bye?",           MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2)));
    }
    */

    /*
    static function OnShutdown() {
            MessageBox.Show("Fiddler Classic has shutdown");
    }
    */

    /*
    static function OnAttach() {
        MessageBox.Show("Fiddler Classic is now the system proxy");
    }
    */

    /*
    static function OnDetach() {
        MessageBox.Show("Fiddler Classic is no longer the system proxy");
    }
    */

    // The Main() function runs everytime your FiddlerScript compiles
    static function Main() {
        var today: Date = new Date();
        FiddlerObject.StatusText = " CustomRules.js was loaded at: " + today;

        // Uncomment to add a "Server" column containing the response "Server" header, if present
        // UI.lvSessions.AddBoundColumn("Server", 50, "@response.server");

        // Uncomment to add a global hotkey (Win+G) that invokes the ExecAction method below...
        // UI.RegisterCustomHotkey(HotkeyModifiers.Windows, Keys.G, "screenshot"); 
    }

    // These static variables are used for simple breakpointing & other QuickExec rules 
    BindPref("fiddlerscript.ephemeral.bpRequestURI")
    public static var bpRequestURI:String = null;

    BindPref("fiddlerscript.ephemeral.bpResponseURI")
    public static var bpResponseURI:String = null;

    BindPref("fiddlerscript.ephemeral.bpMethod")
    public static var bpMethod: String = null;

    static var bpStatus:int = -1;
    static var uiBoldURI: String = null;
    static var gs_ReplaceToken: String = null;
    static var gs_ReplaceTokenWith: String = null;
    static var gs_OverridenHost: String = null;
    static var gs_OverrideHostWith: String = null;

    // The OnExecAction function is called by either the QuickExec box in the Fiddler Classic window, // or by the ExecAction.exe command line utility.
    static function OnExecAction(sParams: String[]): Boolean {

        FiddlerObject.StatusText = "ExecAction: " + sParams[0];

        var sAction = sParams[0].toLowerCase();
        switch (sAction) {
            case "bold":
                if (sParams.Length<2) {uiBoldURI=null; FiddlerObject.StatusText="Bolding cleared"; return false;}
                uiBoldURI = sParams[1]; FiddlerObject.StatusText="Bolding requests for " + uiBoldURI;
                return true;
            case "bp":
                FiddlerObject.alert("bpu = breakpoint request for uri\nbpm = breakpoint request method\nbps=breakpoint response status\nbpafter = breakpoint response for URI");
                return true;
            case "bps":
                if (sParams.Length<2) {bpStatus=-1; FiddlerObject.StatusText="Response Status breakpoint cleared"; return false;}
                bpStatus = parseInt(sParams[1]); FiddlerObject.StatusText="Response status breakpoint for " + sParams[1];
                return true;
            case "bpv":
            case "bpm":
                if (sParams.Length<2) {bpMethod=null; FiddlerObject.StatusText="Request Method breakpoint cleared"; return false;}
                bpMethod = sParams[1].toUpperCase(); FiddlerObject.StatusText="Request Method breakpoint for " + bpMethod;
                return true;
            case "bpu":
                if (sParams.Length<2) {bpRequestURI=null; FiddlerObject.StatusText="RequestURI breakpoint cleared"; return false;}
                bpRequestURI = sParams[1]; 
                FiddlerObject.StatusText="RequestURI breakpoint for "+sParams[1];
                return true;
            case "bpa":
            case "bpafter":
                if (sParams.Length<2) {bpResponseURI=null; FiddlerObject.StatusText="ResponseURI breakpoint cleared"; return false;}
                bpResponseURI = sParams[1]; 
                FiddlerObject.StatusText="ResponseURI breakpoint for "+sParams[1];
                return true;
            case "overridehost":
                if (sParams.Length<3) {gs_OverridenHost=null; FiddlerObject.StatusText="Host Override cleared"; return false;}
                gs_OverridenHost = sParams[1].toLowerCase();
                gs_OverrideHostWith = sParams[2];
                FiddlerObject.StatusText="Connecting to [" + gs_OverrideHostWith + "] for requests to [" + gs_OverridenHost + "]";
                return true;
            case "urlreplace":
                if (sParams.Length<3) {gs_ReplaceToken=null; FiddlerObject.StatusText="URL Replacement cleared"; return false;}
                gs_ReplaceToken = sParams[1];
                gs_ReplaceTokenWith = sParams[2].Replace(" ", "%20");  // Simple helper
                FiddlerObject.StatusText="Replacing [" + gs_ReplaceToken + "] in URIs with [" + gs_ReplaceTokenWith + "]";
                return true;
            case "allbut":
            case "keeponly":
                if (sParams.Length<2) { FiddlerObject.StatusText="Please specify Content-Type to retain during wipe."; return false;}
                UI.actSelectSessionsWithResponseHeaderValue("Content-Type", sParams[1]);
                UI.actRemoveUnselectedSessions();
                UI.lvSessions.SelectedItems.Clear();
                FiddlerObject.StatusText="Removed all but Content-Type: " + sParams[1];
                return true;
            case "stop":
                UI.actDetachProxy();
                return true;
            case "start":
                UI.actAttachProxy();
                return true;
            case "cls":
            case "clear":
                UI.actRemoveAllSessions();
                return true;
            case "g":
            case "go":
                UI.actResumeAllSessions();
                return true;
            case "goto":
                if (sParams.Length != 2) return false;
                Utilities.LaunchHyperlink("https://www.google.com/search?hl=en&btnI=I%27m+Feeling+Lucky&q=" + Utilities.UrlEncode(sParams[1]));
                return true;
            case "help":
                Utilities.LaunchHyperlink("https://api.getfiddler.com/r/?quickexec");
                return true;
            case "hide":
                UI.actMinimizeToTray();
                return true;
            case "log":
                FiddlerApplication.Log.LogString((sParams.Length<2) ? "User couldn't think of anything to say..." : sParams[1]);
                return true;
            case "nuke":
                UI.actClearWinINETCache();
                UI.actClearWinINETCookies(); 
                return true;
            case "screenshot":
                UI.actCaptureScreenshot(false);
                return true;
            case "show":
                UI.actRestoreWindow();
                return true;
            case "tail":
                if (sParams.Length<2) { FiddlerObject.StatusText="Please specify # of sessions to trim the session list to."; return false;}
                UI.TrimSessionList(int.Parse(sParams[1]));
                return true;
            case "quit":
                UI.actExit();
                return true;
            case "dump":
                UI.actSelectAll();
                UI.actSaveSessionsToZip(CONFIG.GetPath("Captures") + "dump.saz");
                UI.actRemoveAllSessions();
                FiddlerObject.StatusText = "Dumped all sessions to " + CONFIG.GetPath("Captures") + "dump.saz";
                return true;

            default:
                if (sAction.StartsWith("http") || sAction.StartsWith("www.")) {
                    System.Diagnostics.Process.Start(sParams[0]);
                    return true;
                }
                else
                {
                    FiddlerObject.StatusText = "Requested ExecAction: '" + sAction + "' not found. Type HELP to learn more.";
                    return false;
                }
        }
    }
}